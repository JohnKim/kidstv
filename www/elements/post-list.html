<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/loading-wave/loading-wave.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../service/post-service.html">

<polymer-element name="post-list" layout vertical>
  <template>
  <style>

  :host {
    display: block;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }


  .item {
    box-sizing: border-box;
    height: 80px;
    padding: 4px;
    background-color: white;
    overflow: hidden;
  }


  h2 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    padding-right: 35px;
    padding-top: 8px;
    text-overflow: ellipsis;
    overflow: hidden;
    -webkit-line-clamp: 2;
    display: -webkit-box;
    -webkit-box-orient: vertical;
  }

  img {
    float: left;
    margin: 5px;
    width: 70px;
    border-radius: 50%;
    padding-right: 4px;
  }

  p {
    text-overflow: ellipsis;
    overflow: hidden;
    -webkit-line-clamp: 2;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    padding-right: 30px;
    margin-top: 1px;
    font-size: 12px;
  }


  paper-icon-button {
    position: absolute;
    top: 5px;
    right: 1px;
    color: #919191;
  }


  </style>

  <post-service id="service" posts="{{posts}}"></post-service>

  <core-list id="list" data="{{posts}}" selectionEnabled="{{selectionEnabled}}" selection="{{selection}}" height="80" flex
    multi?={{multi}} on-scroll="{{scrollEventHandler}}">

    <template>
      <div class="item">
        <div class="message">
          <img src="{{model.image}}" width="70" height="70" data-videoId="{{model.id}}" on-tap="{{openWindow}}">
          <h2 data-videoId="{{model.id}}" on-tap="{{openWindow}}">{{model.title}}</h2>
          <p>{{model.description}}</p>
          <paper-icon-button
            id="favicon"
            icon="favorite"
            on-tap="{{favoriteTapped}}">
          </paper-icon-button>
        </div>
      </div>
    </template>

  </core-list>

</template>
<script>
(function() {

  Polymer('post-list', {
    selectionEnabled: true,
    multi: false,

    ready: function() {
      this.posts = [];
    },

    scrollEventHandler: function(event) {
      var firstVisibleIndex = Math.floor(this.$.list._scrollTop / this.$.list.height);
      var visibleMidpoint = firstVisibleIndex + this.$.list._visibleCount / 2;

      console.log(this.$.list._scrollTop, firstVisibleIndex, visibleMidpoint, Math.max(0, Math.floor(visibleMidpoint - this.$.list._physicalCount / 2)));


      if(visibleMidpoint > 90 && visibleMidpoint < 100){
      }

      if(firstVisibleIndex == 0) {
        mainScrollEventHandler(firstVisibleIndex);
      }else{

      }
    },

    openWindow: function(event, cn, el) {
      var url = "http://www.youtube.com/embed/" + el.getAttribute('data-videoId') + "?enablejsapi=1&loop=1&autoplay=1";
      var iab = window.open(url, '_blank', 'location=no,EnableViewPortScale=yes');

      if (!iab) {
        alert('window.open returned ' + iab);
      }

    },

    favoriteTapped: function(event, detail, sender) {
      this.favorite = !this.favorite;
      this.fire('favorite-tap');
    },

    retrieve: function(channelId){
      this.$.service.retrievePosts(channelId);
    },

    handleFavorite: function(event, detail, sender) {
      var post = sender.templateInstance.model.post;
      this.$.service.setFavorite(post.uid, post.favorite);
    }

  });
})();
</script>
</polymer-element>
